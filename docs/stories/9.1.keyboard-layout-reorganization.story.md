# Story 9.1: Keyboard Layout Reorganization

<!-- Powered by BMAD‚Ñ¢ Core -->

## Status

In Progress

---

## Story

**As a** keyboard user,
**I want** the Settings button moved to the left and a new Prompt button on the right,
**so that** I can easily access LinkedIn profile search functionality.

---

## Acceptance Criteria

1. Settings button relocated to left side of utility row
2. New "Prompt" button added to right side of utility row
3. Prompt button has distinct visual styling (blue/purple accent, icon: magnifying glass or "üîç")
4. Button disabled when text input is empty
5. Button enabled when text input contains 2+ characters
6. Tapping Prompt button triggers LinkedIn search flow
7. Visual feedback on tap (highlight, haptic feedback)
8. Maintains existing keyboard color scheme (light/dark mode support)
9. Preserves all existing keyboard functionality (typing, delete, shift, layout switching)
10. Unit tests verify button placement and state management

---

## Tasks / Subtasks

- [x] **Task 1: Modify Top Toolbar Layout** (AC: 1, 2)
  - [x] Update `setupTopToolbar()` method in KeyboardViewController.swift
  - [x] Move Settings button from right to left side (swap positions with Scan button)
  - [x] Adjust constraints: Settings button `leadingAnchor` instead of `trailingAnchor`
  - [x] Adjust Scan button position if needed to maintain spacing
  - [x] Verify toolbar still renders correctly at height 32pt

- [x] **Task 2: Create Prompt Button UI Component** (AC: 2, 3, 8)
  - [x] Create new UIButton instance for Prompt button in `setupTopToolbar()`
  - [x] Set button title to "üîç" or "üîç Search" (icon: magnifying glass)
  - [x] Apply blue/purple accent styling: `backgroundColor = UIColor.systemBlue.withAlphaComponent(0.2)`
  - [x] Set title color: `.setTitleColor(.systemBlue, for: .normal)`
  - [x] Add corner radius: `layer.cornerRadius = 6`
  - [x] Set font: `.systemFont(ofSize: 14, weight: .medium)`
  - [x] Add to toolbar: `toolbar.addSubview(promptButton)`
  - [x] Apply constraints: `trailingAnchor` to toolbar trailing, width ~80pt, height 28pt
  - [x] Ensure button respects light/dark mode color schemes

- [x] **Task 3: Implement Button State Management** (AC: 4, 5)
  - [x] Add property: `private var promptButton: UIButton?` to KeyboardViewController
  - [x] Create method: `private func updatePromptButtonState()`
  - [x] Check text input length via `textDocumentProxy.documentContextBeforeInput`
  - [x] Disable button when text is empty or less than 2 characters: `isEnabled = false`, alpha 0.5
  - [x] Enable button when text has 2+ characters: `isEnabled = true`, alpha 1.0
  - [x] Call `updatePromptButtonState()` in `textDidChange(_:)` method
  - [x] Call `updatePromptButtonState()` in `viewDidLoad()` to set initial state

- [x] **Task 4: Add Button Tap Action Handler** (AC: 6, 7)
  - [x] Create method: `@objc private func promptButtonTapped()`
  - [x] Add target/action to button: `promptButton.addTarget(self, action: #selector(promptButtonTapped), for: .touchUpInside)`
  - [x] Add haptic feedback: `feedbackGenerator?.impactOccurred(style: .medium)` (reuse existing feedbackGenerator)
  - [x] For now, log action: `print("üîç Prompt button tapped")` (actual LinkedIn search will be implemented in Story 9.3)
  - [x] Show placeholder toast message: `showToast("LinkedIn search coming soon!")` (temporary)

- [ ] **Task 5: Verify Existing Functionality Preservation** (AC: 9)
  - [ ] Manual testing: Verify all letter keys still work
  - [ ] Manual testing: Verify shift key, delete key, space bar still work
  - [ ] Manual testing: Verify layout switching (letters, numbers, symbols) still works
  - [ ] Manual testing: Verify Scan button still triggers screenshot scan flow
  - [ ] Manual testing: Verify text analysis and banner alerts still appear
  - [ ] Visual regression: Check keyboard height, spacing, alignment unchanged

- [x] **Task 6: Write Unit Tests** (AC: 10)
  - [x] Test file: `TypeSafeTests/KeyboardViewControllerPromptButtonTests.swift`
  - [x] Test: `testPromptButtonExistsInToolbar()` - verify button is added to view hierarchy
  - [x] Test: `testPromptButtonDisabledWhenTextEmpty()` - verify initial disabled state
  - [x] Test: `testPromptButtonEnabledWhenTextLength2Plus()` - simulate text input, verify enabled
  - [x] Test: `testPromptButtonDisabledWhenTextTooShort()` - simulate 1-char input, verify disabled
  - [x] Test: `testPromptButtonTapTriggersHandler()` - mock tap, verify handler called
  - [x] Test: `testSettingsButtonMovedToLeft()` - verify settings button position is left side
  - [x] Test: `testPromptButtonOnRight()` - verify prompt button position is right side
  - [x] Test: `testPromptButtonStyling()` - verify blue accent color, corner radius, font

---

## Dev Notes

### Previous Story Insights
No previous stories in this epic (9.1 is the first story). This story is part of Epic 9 which builds on existing keyboard infrastructure from Epic 2 (Keyboard Extension).

### Architecture Context

**Source: Component Responsibilities** [Source: docs/architecture/component-responsibilities.md]
- Keyboard Extension (Swift + UIKit) is responsible for capturing typed text via `UITextDocumentProxy`
- Keyboard displays inline risk banners and popovers
- Keyboard makes HTTPS calls to backend when Full Access is granted

**Source: Existing KeyboardViewController Implementation** [Source: TypeSafeKeyboard/KeyboardViewController.swift]
- Current toolbar setup is in `setupTopToolbar()` method (line 239-287)
- Current layout: Scan button on LEFT (leadingAnchor), Settings button on RIGHT (trailingAnchor)
- Toolbar height: 32pt, button sizes: Scan ~80pt width, Settings ~36pt width, both 28pt height
- Toolbar spacing: 8pt margins from edges
- Color scheme: Uses `UIColor.systemBlue` and `UIColor.systemGray` with alpha for consistency
- Dark mode support: Automatically handled by system colors
- Existing haptic feedback generator: `feedbackGenerator: UIImpactFeedbackGenerator?` (initialized in viewDidLoad if Full Access enabled)

**Source: Color Constants** [Source: TypeSafeKeyboard/KeyboardViewController.swift lines 26-35]
```swift
// Light mode colors
private let lightKeyBackground = UIColor(white: 0.97, alpha: 1.0)  // #F8F8F8
private let lightKeyboardBackground = UIColor(white: 0.85, alpha: 1.0)  // #D9D9D9
private let lightTextColor = UIColor.black

// Dark mode colors
private let darkKeyBackground = UIColor(white: 0.29, alpha: 1.0)  // #4A4A4A
private let darkKeyboardBackground = UIColor(white: 0.10, alpha: 1.0)  // #191919
private let darkTextColor = UIColor.white
```

**Source: TextDocumentProxy for Text Input** [Source: docs/architecture/component-responsibilities.md]
- Use `textDocumentProxy.documentContextBeforeInput` to get current text before cursor
- This is the standard iOS UIInputViewController API for reading text in any app
- Returns optional String, need to check for nil and validate length

### File Locations

**Primary Implementation File:**
- `TypeSafeKeyboard/KeyboardViewController.swift` - Main keyboard controller
  - Method to modify: `setupTopToolbar()` (lines 239-287)
  - Method to add: `promptButtonTapped()`
  - Method to add: `updatePromptButtonState()`
  - Property to add: `private var promptButton: UIButton?`

**Test Files:**
- Create: `TypeSafeTests/KeyboardViewControllerPromptButtonTests.swift`
- Reference existing test pattern: `TypeSafeTests/KeyboardViewControllerBannerTests.swift`

### Project Structure Notes

**Source Tree Alignment:** [Inferred from existing codebase structure]
```
TypeSafe/
‚îú‚îÄ‚îÄ TypeSafeKeyboard/           # Keyboard extension target
‚îÇ   ‚îú‚îÄ‚îÄ KeyboardViewController.swift   # Main file to modify
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ UI/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ TypeSafeTests/              # Unit tests
‚îÇ   ‚îú‚îÄ‚îÄ KeyboardViewControllerBannerTests.swift  # Pattern reference
‚îÇ   ‚îî‚îÄ‚îÄ KeyboardViewControllerPromptButtonTests.swift  # New test file
```

### Technical Constraints

**Performance Considerations:** [Source: docs/architecture/performance-capacity.md]
- Response time requirement: < 2 seconds per scan (applies to future LinkedIn search, not this story)
- UI operations must be on main thread
- Button state updates should be lightweight (no heavy computation)

**Security & Privacy:** [Source: docs/architecture/security-privacy.md]
- Full Access permission required for network calls (already handled by existing keyboard)
- No PII should be stored in button state management
- Text reading via `textDocumentProxy` is ephemeral (not stored)

### Design Patterns to Follow

**Button Creation Pattern:** [Source: TypeSafeKeyboard/KeyboardViewController.swift lines 246-254]
```swift
// Example from existing Scan button
let button = UIButton(type: .system)
button.setTitle("üì∏ Scan", for: .normal)
button.titleLabel?.font = .systemFont(ofSize: 14, weight: .medium)
button.backgroundColor = UIColor.systemBlue.withAlphaComponent(0.2)
button.setTitleColor(.systemBlue, for: .normal)
button.layer.cornerRadius = 6
button.translatesAutoresizingMaskIntoConstraints = false
button.addTarget(self, action: #selector(actionName), for: .touchUpInside)
```

**Constraint Pattern:** [Source: TypeSafeKeyboard/KeyboardViewController.swift lines 268-286]
```swift
NSLayoutConstraint.activate([
    button.trailingAnchor.constraint(equalTo: toolbar.trailingAnchor, constant: -8),
    button.centerYAnchor.constraint(equalTo: toolbar.centerYAnchor),
    button.widthAnchor.constraint(equalToConstant: 80),
    button.heightAnchor.constraint(equalToConstant: 28)
])
```

### Integration with Future Stories

**Story 9.3 Dependencies:**
- Story 9.3 will implement actual LinkedIn search when Prompt button is tapped
- Current story creates the UI foundation and button handler stub
- Handler method `promptButtonTapped()` will be expanded in 9.3 to call KeyboardAPIService

### Edge Cases to Handle

1. **Empty Text Field:** Button should be disabled, alpha 0.5
2. **Single Character:** Button should remain disabled (need 2+ chars)
3. **Field Change:** Button state should reset when user switches text fields (`textDidChange` already has this logic)
4. **Secure Text Fields:** Button should still appear but might want to disable for password fields (follow existing secure field handling pattern if present)

---

## Testing

### Testing Standards

**Test File Location:** [Source: docs/architecture/observability-testing.md]
- Unit tests go in `TypeSafeTests/` directory
- Test files should match the class being tested: `{ClassName}Tests.swift`
- For this story: `TypeSafeTests/KeyboardViewControllerPromptButtonTests.swift`

**Testing Frameworks:** [Inferred from existing test files]
- XCTest framework (standard iOS testing)
- Test classes inherit from `XCTestCase`
- Use `XCTAssertTrue`, `XCTAssertEqual`, `XCTAssertNotNil` for assertions

**Test Structure Pattern:** [Standard iOS testing pattern]
```swift
import XCTest
@testable import TypeSafe

class KeyboardViewControllerPromptButtonTests: XCTestCase {
    var sut: KeyboardViewController!

    override func setUp() {
        super.setUp()
        sut = KeyboardViewController()
        sut.loadViewIfNeeded()
    }

    override func tearDown() {
        sut = nil
        super.tearDown()
    }

    func testPromptButtonExists() {
        // Test implementation
    }
}
```

**Specific Testing Requirements for This Story:**
- Test button exists in view hierarchy after `setupTopToolbar()` is called
- Test button state changes correctly based on text input length
- Test button tap triggers the action handler
- Test button positioning (left vs right side)
- Test visual styling (color, corner radius, font)
- Mock `textDocumentProxy` to simulate different text input scenarios

**UI Testing:** [Source: docs/architecture/observability-testing.md]
- iOS UI tests for keyboard banner visibility
- For this story: Manual QA testing recommended for layout verification
- Visual regression testing: Compare before/after screenshots

**Performance Testing:**
- Button state update should be instant (< 16ms for 60fps)
- No noticeable lag when typing and button state changes

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - Implementation completed without issues

### Completion Notes
- Successfully reorganized keyboard toolbar layout
- Settings button moved to left side, Prompt button added to right side
- Implemented full button state management (disabled when <2 chars, enabled when >=2 chars)
- Added haptic feedback and placeholder toast message
- Button styling matches existing keyboard design (blue accent, 6pt corner radius)
- All code compiles successfully
- Unit test file created (test execution requires manual QA on physical device/simulator)
- Task 5 (Manual Testing) requires QA validation before marking story complete
- Story is READY for manual testing and QA review

### File List
**Modified Files:**
- TypeSafeKeyboard/KeyboardViewController.swift

**New Files:**
- TypeSafeTests/KeyboardViewControllerPromptButtonTests.swift

---

## QA Results
*To be filled by QA Agent*
