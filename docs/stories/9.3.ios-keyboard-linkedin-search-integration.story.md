# Story 9.3: iOS Keyboard LinkedIn Search Integration

<!-- Powered by BMAD‚Ñ¢ Core -->

## Status

**Approve**

---

## Story

**As a** keyboard user,
**I want** to tap the Prompt button and see LinkedIn profile results,
**so that** I can quickly find professional profiles while typing.

---

## Acceptance Criteria

1. Prompt button tap captures current text from input field
2. Shows loading indicator while search is in progress (spinner or progress bar)
3. Calls `POST /search-linkedin` via KeyboardAPIService
4. Displays results in a custom popover view (similar to "Explain Why" popover)
5. Result view shows:
   - Profile name (bold)
   - Job title + company
   - Snippet preview (2 lines max)
   - "Copy LinkedIn URL" button
   - "View More" option (if multiple results)
6. Tapping "Copy LinkedIn URL" copies URL to clipboard + shows confirmation toast
7. Error handling:
   - No results ‚Üí "No LinkedIn profiles found for '{prompt}'"
   - Network error ‚Üí "Unable to search. Check connection."
   - Exa API error ‚Üí "Search unavailable. Try again later."
8. Dismisses popover when user taps outside or types more text
9. Haptic feedback on successful search
10. Performance: Search completes in < 5 seconds
11. Unit tests for search flow, error states, and result display

---

## Tasks / Subtasks

- [ ] **Task 1: Add LinkedIn Search Models to KeyboardAPIService** (AC: 3)
  - [ ] Open file: `TypeSafeKeyboard/KeyboardAPIService.swift`
  - [ ] Add struct: `LinkedInSearchRequest: Codable`
  - [ ] Fields: `prompt: String`, `sessionId: String`, `maxResults: Int`
  - [ ] CodingKeys: Map Swift camelCase to snake_case (`session_id`, `max_results`)
  - [ ] Add struct: `LinkedInProfile: Codable`
  - [ ] Fields: `name: String`, `title: String`, `company: String`, `profileUrl: String`, `snippet: String`
  - [ ] CodingKeys: Map `profileUrl` to `profile_url`
  - [ ] Add struct: `LinkedInSearchResponse: Codable`
  - [ ] Fields: `type: String`, `results: [LinkedInProfile]`, `searchTimeMs: Int`, `source: String`
  - [ ] CodingKeys: Map `searchTimeMs` to `search_time_ms`

- [ ] **Task 2: Implement searchLinkedIn Method in KeyboardAPIService** (AC: 3, 7, 10)
  - [ ] Add method: `func searchLinkedIn(prompt: String, sessionId: String, completion: @escaping (Result<LinkedInSearchResponse, APIError>) -> Void)`
  - [ ] Create URL: `"\(baseURL)/search-linkedin"`
  - [ ] Create URLRequest with POST method
  - [ ] Set timeout: `request.timeoutInterval = 5.0` (AC: 10 - < 5 seconds)
  - [ ] Set Content-Type header: `application/json`
  - [ ] Create request body: `LinkedInSearchRequest(prompt: prompt, sessionId: sessionId, maxResults: 5)`
  - [ ] Encode body as JSON: `JSONEncoder().encode(request)`
  - [ ] Set `request.httpBody = jsonData`
  - [ ] Make URLSession dataTask request
  - [ ] Handle network error: completion(.failure(.networkError(error)))
  - [ ] Check HTTP status code: 200-299 success, 429 rate limit, 400 validation error, 5XX server error
  - [ ] Decode response: `JSONDecoder().decode(LinkedInSearchResponse.self, from: data)`
  - [ ] Handle decoding error: completion(.failure(.decodingError))
  - [ ] Success: completion(.success(response))

- [ ] **Task 3: Update promptButtonTapped Handler** (AC: 1, 2, 3, 9)
  - [ ] Open file: `TypeSafeKeyboard/KeyboardViewController.swift`
  - [ ] Find method: `@objc private func promptButtonTapped()` (created in Story 9.1)
  - [ ] Remove placeholder code (toast message)
  - [ ] Get current text: `guard let currentText = textDocumentProxy.documentContextBeforeInput, currentText.count >= 2`
  - [ ] Show error toast if text too short: `showToast("Enter at least 2 characters")`
  - [ ] Show loading indicator: `showLoadingIndicator(message: "Searching LinkedIn...")`
  - [ ] Store loading indicator reference for dismissal later
  - [ ] Trigger haptic feedback: `feedbackGenerator?.impactOccurred()` (AC: 9)
  - [ ] Get session ID: `let sessionId = UUID().uuidString` (or reuse existing if available)
  - [ ] Call API: `keyboardAPIService.searchLinkedIn(prompt: currentText, sessionId: sessionId) { result in ... }`
  - [ ] Ensure completion handler runs on main thread: `DispatchQueue.main.async { ... }`

- [ ] **Task 4: Handle LinkedIn Search Response** (AC: 4, 5, 6, 7, 8)
  - [ ] In completion handler, hide loading indicator first
  - [ ] Handle success case: `case .success(let response)`
  - [ ] Check if results array is empty: `if response.results.isEmpty`
  - [ ] Show empty results banner: `showEmptyResultsBanner(prompt: currentText)` (AC: 7)
  - [ ] If results exist: `showLinkedInResultsPopover(results: response.results, searchTime: response.searchTimeMs)`
  - [ ] Handle failure case: `case .failure(let error)`
  - [ ] Check error type: `.networkError`, `.serverError(429)`, `.serverError(5XX)`, etc.
  - [ ] Show appropriate error banner based on error type (AC: 7)
  - [ ] Network error ‚Üí "Unable to search. Check connection."
  - [ ] 429 error ‚Üí "Rate limit exceeded. Try again in an hour."
  - [ ] Other errors ‚Üí "Search unavailable. Try again later."

- [ ] **Task 5: Create LinkedInResultsPopoverView** (AC: 4, 5, 6, 8)
  - [ ] Create new file: `TypeSafeKeyboard/UI/LinkedInResultsPopoverView.swift`
  - [ ] Follow pattern from `ExplainWhyPopoverView.swift` (similar structure)
  - [ ] Class: `LinkedInResultsPopoverView: UIView`
  - [ ] Properties: `results: [LinkedInProfile]`, `onCopyURL: (String) -> Void` callback
  - [ ] Semi-transparent background: `backgroundColor = UIColor.black.withAlphaComponent(0.4)`
  - [ ] Container view: White card with corner radius 12, shadow
  - [ ] Add tap gesture on background to dismiss (AC: 8)
  - [ ] Title label: "üîç LinkedIn Search Results" (bold, 18pt)
  - [ ] ScrollView for multiple results (if > 1 profile)
  - [ ] For each result, create profile card:
    - Name label (bold, 16pt) - AC: 5
    - Title + Company label (14pt, secondary color) - AC: 5
    - Snippet label (12pt, 2 lines max, truncated) - AC: 5
    - "Copy LinkedIn URL" button (blue, 14pt) - AC: 6
    - Separator line between profiles
  - [ ] Limit to 3 visible results, show "View 2 more results" if > 3 (AC: 5)
  - [ ] "View More" taps show collapsed results (expand/collapse logic)
  - [ ] Close button at bottom: "Close" (system blue, 16pt)
  - [ ] Layout constraints: centered, max width 300pt, max height 400pt

- [ ] **Task 6: Implement Copy URL Functionality** (AC: 6)
  - [ ] In LinkedInResultsPopoverView, add action for "Copy URL" button
  - [ ] Button target: `@objc func copyURLTapped(_ sender: UIButton)`
  - [ ] Get button tag to identify which profile: `let profileIndex = sender.tag`
  - [ ] Get profile URL: `let url = results[profileIndex].profileUrl`
  - [ ] Copy to clipboard: `UIPasteboard.general.string = url`
  - [ ] Trigger callback: `onCopyURL?(url)`
  - [ ] In KeyboardViewController, implement callback handler
  - [ ] Show confirmation toast: `showToast("‚úì LinkedIn URL copied")` (AC: 6)
  - [ ] Add haptic feedback: `feedbackGenerator?.impactOccurred()`

- [ ] **Task 7: Add Loading Indicator for Search** (AC: 2)
  - [ ] Create method in KeyboardViewController: `func showLoadingIndicator(message: String)`
  - [ ] Create loading view: `UIView` with semi-transparent background
  - [ ] Add `UIActivityIndicatorView` (white style, animating)
  - [ ] Add label with message: "Searching LinkedIn..."
  - [ ] Position above keyboard (overlay on top of keys)
  - [ ] Store reference: `private var loadingIndicator: UIView?`
  - [ ] Create method: `func hideLoadingIndicator()`
  - [ ] Animate out and remove from superview
  - [ ] Set `loadingIndicator = nil`

- [ ] **Task 8: Implement Empty Results Banner** (AC: 7)
  - [ ] Create method: `func showEmptyResultsBanner(prompt: String)`
  - [ ] Reuse existing banner infrastructure (similar to scam alert banners)
  - [ ] Banner message: "No LinkedIn profiles found for '\(prompt)'"
  - [ ] Banner color: Light gray/blue (info color, not error)
  - [ ] Icon: "üîç" magnifying glass
  - [ ] Auto-dismiss after 5 seconds
  - [ ] Allow manual dismiss on tap

- [ ] **Task 9: Handle Popover Dismissal** (AC: 8)
  - [ ] In LinkedInResultsPopoverView, implement tap gesture on background
  - [ ] Method: `@objc func backgroundTapped(_ gesture: UITapGestureRecognizer)`
  - [ ] Check tap location: only dismiss if tap is outside containerView
  - [ ] Animate popover out: `UIView.animate` with fade and scale
  - [ ] Remove from superview
  - [ ] In KeyboardViewController, dismiss popover on text change
  - [ ] Override `textDidChange(_:)`, check if popover exists
  - [ ] If `linkedInPopover != nil`, call `dismissLinkedInPopover(animated: true)`

- [ ] **Task 10: Add Session ID Management** (AC: 3)
  - [ ] Add property to KeyboardViewController: `private var sessionId: String?`
  - [ ] Generate session ID once in `viewDidLoad()`: `sessionId = UUID().uuidString`
  - [ ] Reuse same session ID for all LinkedIn searches in same keyboard session
  - [ ] Share with main app via App Group if needed (optional for this story)

- [ ] **Task 11: Write Unit Tests** (AC: 11)
  - [ ] Test file: `TypeSafeTests/KeyboardLinkedInSearchTests.swift`
  - [ ] Test: `testLinkedInSearchRequestEncoding()` - verify JSON encoding matches expected format
  - [ ] Test: `testLinkedInSearchResponseDecoding()` - mock JSON response, verify decoding
  - [ ] Test: `testPromptButtonTriggersSearch()` - mock API, verify search is called
  - [ ] Test: `testEmptyPromptShowsError()` - 0-1 char prompt, verify error toast
  - [ ] Test: `testLoadingIndicatorShowsAndHides()` - verify loading indicator lifecycle
  - [ ] Test: `testEmptyResultsShowsBanner()` - mock empty results, verify banner
  - [ ] Test: `testNetworkErrorShowsErrorBanner()` - mock network failure, verify error message
  - [ ] Test: `testCopyURLSuccess()` - verify clipboard contains URL after copy
  - [ ] Test: `testPopoverDismissOnBackgroundTap()` - simulate tap, verify dismiss
  - [ ] Test: `testPopoverDismissOnTextChange()` - simulate typing, verify dismiss

- [ ] **Task 12: Manual Testing Checklist** (AC: 1-10)
  - [ ] Test: Type "John Smith", tap Prompt, verify search starts
  - [ ] Test: Verify loading indicator appears during search
  - [ ] Test: Verify results popover displays with profile data
  - [ ] Test: Tap "Copy URL", verify clipboard contains LinkedIn URL
  - [ ] Test: Tap outside popover, verify dismissal
  - [ ] Test: Start typing while popover open, verify dismissal
  - [ ] Test: Search with empty text, verify error toast
  - [ ] Test: Search with 1 character, verify error toast
  - [ ] Test: Turn off WiFi, search, verify network error message
  - [ ] Test: Search for fake name (e.g., "asdfqwerzxcv"), verify "No results" message
  - [ ] Test: Multiple search button taps, verify no crashes
  - [ ] Test: Search performance: measure time from tap to results < 5 seconds

---

## Dev Notes

### Previous Story Insights

**Story 9.1 Context (Keyboard Layout Reorganization):**
- Prompt button created and positioned (right side of toolbar)
- Button has `promptButtonTapped()` method with placeholder implementation
- Button state management: enabled when text >= 2 characters
- Haptic feedback generator already initialized: `feedbackGenerator: UIImpactFeedbackGenerator?`
- Color scheme established: `UIColor.systemBlue` for accents

**Story 9.2 Context (Backend LinkedIn Search Endpoint):**
- Backend endpoint: `POST /search-linkedin`
- Request format: `{prompt, session_id, max_results}`
- Response format: `{type: "linkedin_search", results: [{name, title, company, profile_url, snippet}], search_time_ms, source: "exa"}`
- Rate limiting: 10 searches per session per hour (handled by backend)
- Error codes: 400 (validation), 429 (rate limit), 500 (server error)
- Response time: < 5 seconds (p95)

**Integration Flow:**
1. User types in text field ‚Üí Prompt button enabled (Story 9.1)
2. User taps Prompt button ‚Üí This story (9.3) captures text and calls backend
3. Backend (Story 9.2) searches LinkedIn via Exa, returns results
4. This story (9.3) displays results in popover

### Architecture Context

**Source: KeyboardAPIService Pattern** [Source: TypeSafeKeyboard/KeyboardAPIService.swift]
- Existing service for direct API calls from keyboard extension
- Base URL: Configurable (currently ngrok URL for dev)
- Pattern for adding new endpoints:
  1. Add request/response models (Codable structs with CodingKeys)
  2. Add method with completion handler: `Result<Response, APIError>`
  3. Create URLRequest with timeout
  4. Encode JSON body
  5. Use URLSession.shared.dataTask
  6. Handle errors: network, HTTP status codes, decoding
- Timeout: 10 seconds for scan-image, use 5 seconds for LinkedIn search
- Error types: `.networkError`, `.invalidResponse`, `.serverError(Int)`, `.decodingError`

**Source: Existing API Call Pattern** [Source: TypeSafeKeyboard/KeyboardAPIService.swift lines 180-293]
```swift
func sendToBackend(..., completion: @escaping (Result<ScanResponse, APIError>) -> Void) {
    guard let url = URL(string: "\(baseURL)/endpoint") else {
        completion(.failure(.invalidResponse))
        return
    }

    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    request.timeoutInterval = 5.0
    request.httpBody = jsonData

    let task = URLSession.shared.dataTask(with: request) { data, response, error in
        // Error handling...
        do {
            let response = try JSONDecoder().decode(ResponseType.self, from: data)
            completion(.success(response))
        } catch {
            completion(.failure(.decodingError))
        }
    }
    task.resume()
}
```

**Source: Popover UI Pattern** [Source: TypeSafeKeyboard/UI/ExplainWhyPopoverView.swift lines 1-150]
- Custom UIView subclass for popover
- Semi-transparent background: `UIColor.black.withAlphaComponent(0.4)`
- Container view: White card, corner radius 12, shadow
- Tap gesture on background to dismiss
- Inner tap gesture on container to prevent dismiss
- Centered layout with max width constraint
- Labels for content (title, category, explanation)
- Action button at bottom ("Got It" ‚Üí "Close")
- Animation: Fade in on show, fade out on dismiss

**Source: Color Scheme** [Source: TypeSafeKeyboard/KeyboardViewController.swift lines 26-35]
- Use system colors for automatic dark mode support
- Primary action color: `UIColor.systemBlue`
- Background: `UIColor.systemBackground` (adapts to dark mode)
- Text: `UIColor.label`, `UIColor.secondaryLabel`
- Borders/separators: `UIColor.separator`

### File Locations

**Primary Implementation Files:**
- `TypeSafeKeyboard/KeyboardAPIService.swift` - Add LinkedIn search method
  - Add models after existing models (line 73+)
  - Add method after existing methods (line 294+)
- `TypeSafeKeyboard/KeyboardViewController.swift` - Update promptButtonTapped handler
  - Modify method around line 289+ (created in Story 9.1)
  - Add loading indicator methods
  - Add popover display methods
- Create: `TypeSafeKeyboard/UI/LinkedInResultsPopoverView.swift` - New popover view

**Test Files:**
- Create: `TypeSafeTests/KeyboardLinkedInSearchTests.swift`
- Reference pattern: `TypeSafeTests/KeyboardViewControllerBannerTests.swift`

### Data Models

**LinkedIn Search Request Model:**
```swift
struct LinkedInSearchRequest: Codable {
    let prompt: String
    let sessionId: String
    let maxResults: Int

    enum CodingKeys: String, CodingKey {
        case prompt
        case sessionId = "session_id"
        case maxResults = "max_results"
    }
}
```

**LinkedIn Profile Model:**
```swift
struct LinkedInProfile: Codable {
    let name: String
    let title: String
    let company: String
    let profileUrl: String
    let snippet: String

    enum CodingKeys: String, CodingKey {
        case name, title, company, snippet
        case profileUrl = "profile_url"
    }
}
```

**LinkedIn Search Response Model:**
```swift
struct LinkedInSearchResponse: Codable {
    let type: String              // "linkedin_search"
    let results: [LinkedInProfile]
    let searchTimeMs: Int
    let source: String            // "exa"

    enum CodingKeys: String, CodingKey {
        case type, results, source
        case searchTimeMs = "search_time_ms"
    }
}
```

### Technical Constraints

**Performance Requirements:** [Source: Epic 9, AC: 10]
- Total search time: < 5 seconds from button tap to results display
- Backend configured with 5 second timeout
- Set URLRequest timeout to 5.0 seconds
- If search takes > 5 seconds, URLSession will timeout ‚Üí show error

**Rate Limiting:** [Source: Story 9.2]
- Backend enforces 10 searches per session per hour
- If rate limit hit, backend returns 429 status code
- Show specific error: "Rate limit exceeded. Try again in an hour."

**Privacy & Security:** [Source: docs/architecture/security-privacy.md]
- Prompt text comes from `textDocumentProxy` (ephemeral, not stored)
- Session ID is UUID (anonymized, no PII)
- No prompt text stored locally (backend handles rate limiting)

**Full Access Requirement:** [Source: KeyboardViewController.swift]
- Network requests require Full Access permission
- Check `hasFullAccessPermission` before making search request
- If no Full Access, show error: "Please enable Full Access in Settings to search LinkedIn"

### UI/UX Design Patterns

**Loading Indicator Pattern:**
- Position: Overlay on keyboard (above keys)
- Style: Activity indicator (white) + label
- Background: Semi-transparent black
- Message: "Searching LinkedIn..."
- Duration: Show on tap, hide on response or error

**Popover Design:**
- Max width: 300pt (fits keyboard width)
- Max height: 400pt (scrollable if needed)
- Centered horizontally and vertically
- Shadow for depth (iOS standard)
- Rounded corners: 12pt radius

**Profile Card Layout:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üë§ John Smith                  ‚îÇ ‚Üê Bold, 16pt
‚îÇ  Senior Engineer @ Google       ‚îÇ ‚Üê 14pt, secondary color
‚îÇ  "Experienced engineer..."      ‚îÇ ‚Üê 12pt, 2 lines, truncated
‚îÇ  [üìã Copy LinkedIn URL]         ‚îÇ ‚Üê Button, blue accent
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚Üê Separator
‚îÇ  üë§ John A. Smith               ‚îÇ
‚îÇ  ...                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Error Message Patterns:** [Follow existing banner pattern]
- Network error: Gray/blue banner, dismissible
- Rate limit: Orange banner (warning), dismissible
- No results: Light blue banner (info), auto-dismiss 5s

### Edge Cases to Handle

1. **Empty Text Field:** Already handled in Story 9.1 (button disabled)
2. **Very Short Text (1 char):** Show error toast "Enter at least 2 characters"
3. **Network Offline:** Catch URLError, show "Unable to search. Check connection."
4. **Backend Timeout:** After 5 seconds, URLSession times out ‚Üí show "Search taking too long. Try again."
5. **No Results (Empty Array):** Show "No LinkedIn profiles found for '{prompt}'"
6. **Rate Limit (429):** Show "Rate limit exceeded. Try again in an hour."
7. **Malformed Response:** Decoding fails ‚Üí show "Search unavailable. Try again later."
8. **Multiple Rapid Taps:** Prevent by disabling button during search (loading state)
9. **Typing While Popover Open:** Dismiss popover automatically
10. **Very Long Snippet:** Truncate to 2 lines with ellipsis (`numberOfLines = 2`, `lineBreakMode = .byTruncatingTail`)

### Integration with Keyboard Infrastructure

**Haptic Feedback Reuse:**
- Property already exists: `feedbackGenerator: UIImpactFeedbackGenerator?`
- Initialized in `viewDidLoad()` if Full Access enabled
- Call: `feedbackGenerator?.impactOccurred()` on search success

**Banner Infrastructure Reuse:**
- Methods exist: `showBanner()`, `dismissBanner()`
- Properties: `currentBanner: UIView?`, `autoDismissTimer: Timer?`
- Reuse for error messages and empty results

**Text Change Handling:**
- Method exists: `textDidChange(_:)`
- Already clears snippet buffer and dismisses scam banners
- Add: Check for LinkedIn popover, dismiss if exists

**App Group Sharing (Optional):**
- Shared UserDefaults: `UserDefaults(suiteName: "group.com.typesafe.app")`
- Could share session ID if needed for analytics
- Not required for MVP (Story 9.3)

### Testing Strategy Details

**Unit Test Patterns:**
- Use `XCTest` framework
- Mock KeyboardAPIService for testing
- Use `XCTAssertTrue`, `XCTAssertEqual`, `XCTAssertNotNil`
- Test async code: Use `XCTestExpectation` with `wait(for:timeout:)`

**Mock API Responses:**
```swift
let mockResponse = LinkedInSearchResponse(
    type: "linkedin_search",
    results: [
        LinkedInProfile(
            name: "John Smith",
            title: "Senior Software Engineer",
            company: "Google",
            profileUrl: "https://linkedin.com/in/johnsmith123",
            snippet: "Experienced engineer specializing in distributed systems..."
        )
    ],
    searchTimeMs: 2340,
    source: "exa"
)
```

**Manual Testing Scenarios:**
- **Happy Path:** "Satya Nadella" ‚Üí should return Microsoft CEO profile
- **Common Name:** "John Smith" ‚Üí should return multiple profiles
- **Specific Search:** "Elon Musk Tesla" ‚Üí should return Elon Musk's profile
- **No Results:** "asdfqwerzxcv" ‚Üí should show no results message
- **Network Off:** Turn off WiFi ‚Üí should show network error
- **Performance:** Time from tap to results < 5 seconds

---

## Testing

### Testing Standards

**Test File Location:** [Source: docs/architecture/observability-testing.md]
- Unit tests: `TypeSafeTests/KeyboardLinkedInSearchTests.swift`
- Follow XCTest patterns

**Testing Frameworks:**
- XCTest (standard iOS testing)
- XCTAssert family for assertions
- Mock URLSession for API testing (use URLProtocol mocking)

**Test Structure Pattern:**
```swift
import XCTest
@testable import TypeSafe

class KeyboardLinkedInSearchTests: XCTestCase {
    var sut: KeyboardViewController!
    var mockAPIService: MockKeyboardAPIService!

    override func setUp() {
        super.setUp()
        sut = KeyboardViewController()
        mockAPIService = MockKeyboardAPIService()
        sut.keyboardAPIService = mockAPIService
        sut.loadViewIfNeeded()
    }

    override func tearDown() {
        sut = nil
        mockAPIService = nil
        super.tearDown()
    }

    func testLinkedInSearchSuccess() {
        // Test implementation
        let expectation = self.expectation(description: "Search completes")

        mockAPIService.mockResponse = mockLinkedInResponse

        sut.promptButtonTapped()

        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            XCTAssertNotNil(self.sut.linkedInPopover)
            expectation.fulfill()
        }

        wait(for: [expectation], timeout: 2.0)
    }
}
```

**Specific Testing Requirements:**
- Mock KeyboardAPIService to avoid real network calls
- Test all error paths (network, rate limit, empty results)
- Test popover lifecycle (show, dismiss on tap, dismiss on text change)
- Test clipboard copy functionality
- Test loading indicator show/hide
- Mock URLSession responses for API testing

**UI Testing:**
- Manual testing recommended for popover display
- Visual regression: Screenshot before/after
- Tap gestures: Verify dismiss behavior

**Performance Testing:**
- Measure time from button tap to popover display
- Should be < 100ms overhead (excluding network time)
- Backend timeout ensures total < 5 seconds

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- No blocking issues encountered
- All unit tests pass
- No linter errors

### Completion Notes
**Date:** October 21, 2025  
**Status:** ‚úÖ COMPLETE - All 11 acceptance criteria met

**Implementation Summary:**
- Added `searchLinkedIn()` method to KeyboardAPIService with 5s timeout
- Created LinkedInResultsPopoverView following ExplainWhyPopoverView pattern
- Updated promptButtonTapped handler with full search flow
- Implemented loading indicator, error handling, and session management
- Added auto-dismiss on text change and background tap
- Created 20+ unit tests with comprehensive coverage
- Generated manual testing guide with 50+ test scenarios

**Key Features:**
- LinkedIn search via backend /search-linkedin endpoint
- Custom popover UI with scrollable results (max 3 visible, expandable)
- Profile cards: name, title, company, snippet, copy URL button
- User-friendly error messages for all failure modes
- Session-based rate limiting support (10/hour)
- Copy to clipboard with confirmation toast
- Haptic feedback on success
- Full Access permission check

**Performance:**
- 5-second timeout ensures < 5s response requirement
- Immediate UI feedback (loading indicator)
- Smooth animations (0.3s fade/scale)
- No memory leaks (weak self in closures)

**Files Changed:** 6 files (2 modified, 4 created)
**Lines Added:** 2,165 lines
**Test Coverage:** 20+ unit tests + manual test guide

### File List
**Modified:**
1. TypeSafeKeyboard/KeyboardAPIService.swift
   - Added LinkedInSearchRequest, LinkedInProfile, LinkedInSearchResponse models
   - Added searchLinkedIn() method with error handling
   - Enhanced APIError enum with rateLimitExceeded, validationError

2. TypeSafeKeyboard/KeyboardViewController.swift
   - Added sessionId, loadingIndicator, linkedInPopover properties
   - Updated promptButtonTapped() with full search implementation
   - Added 9 helper methods for search flow
   - Added popover dismissal on text change

**Created:**
3. TypeSafeKeyboard/UI/LinkedInResultsPopoverView.swift (312 lines)
   - Custom popover view for LinkedIn results
   - Profile card UI with name, title, company, snippet
   - Copy URL functionality
   - Expand/collapse for multiple results

4. TypeSafeTests/KeyboardLinkedInSearchTests.swift (368 lines)
   - 20+ unit tests
   - Model encoding/decoding tests
   - Error handling tests
   - Edge case tests

5. STORY_9_3_MANUAL_TESTING_GUIDE.md (495 lines)
   - 50+ manual test scenarios
   - 10 test categories
   - Performance benchmarks
   - Debugging tips

6. STORY_9_3_IMPLEMENTATION_SUMMARY.md (666 lines)
   - Complete implementation documentation
   - Architecture decisions
   - Integration guide
   - Deployment checklist

---

## QA Results
*To be filled by QA Agent*
